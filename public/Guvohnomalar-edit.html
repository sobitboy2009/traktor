<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Guvohnomani Tahrirlash - MMM TRAKTOR SERVIS</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="index.css">
    <style>
        .form-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .form-header {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -30px -30px 30px -30px;
        }
        .form-section {
            border-bottom: 2px dashed #e9ecef;
            padding-bottom: 25px;
            margin-bottom: 25px;
        }
        .form-section:last-child {
            border-bottom: none;
        }
        .section-title {
            color: #ffc107;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffc107;
            margin-bottom: 20px;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .required:after {
            content: " *";
            color: #dc3545;
        }
        .date-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        @media (max-width: 768px) {
            .checkbox-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            .date-inputs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <header id="header" class="header fixed-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-between">
            <a href="index.html" class="logo d-flex align-items-center">
                <img src="MMM_Traktor_servis.images/logoOrg.png" alt="" >
                <span class="d-none d-lg-block" style="font-size: 21px; font-weight: 700; color: navy;">MEXANIZATORLAR MAKTABI</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item dropdown pe-3">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img src="MMM_Traktor_servis.images/Без названия.jpg" alt="Profile" class="rounded-circle">
                        <span class="d-none d-md-block dropdown-toggle ps-2">Administrator</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li>
                            <button onclick="logout()" class="btn btn-sm btn-outline-dark m-3">
                                Tizimdan chiqish <i class="bi bi-box-arrow-right"></i>
                            </button>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <aside id="sidebar" class="sidebar" style="background-color: #cff4fc;">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="bi bi-grid" style="font-size: 22px;"></i>
                    <span>Bosh sahifa</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#users-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-people" style="font-size: 22px;"></i><span>O'quvchilar</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="users-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="students-list.html">
                            <i style="font-size: 20px;" class="bi bi-list-check"></i><span>Ro'yxatni ko'rish</span>
                        </a>
                    </li>
                    <li>
                        <a href="students-add.html">
                            <i style="font-size: 20px;" class="bi bi-plus-circle"></i><span>Yangi yaratish</span>
                        </a>
                    </li>
                </ul>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#exams-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-file-earmark-pdf" style="font-size: 22px;"></i><span>Guvohnomalar</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="exams-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="Guvohnomalar-list.html">
                            <i style="font-size: 20px;" class="bi bi-list-check"></i><span>Ro'yxatni ko'rish</span>
                        </a>
                    </li>
                    <li>
                        <a href="Guvohnomalar-add.html">
                            <i style="font-size: 20px;" class="bi bi-plus-circle"></i><span>Yangi yaratish</span>
                        </a>
                    </li>
                    <li>
                        <a href="Guvohnomalar-edit.html" class="active">
                            <i style="font-size: 20px;" class="bi bi-pencil"></i><span>Tahrirlash</span>
                        </a>
                    </li>
                </ul>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" data-bs-target="#invoices-nav" data-bs-toggle="collapse" href="#">
                    <i class="bi bi-cash" style="font-size: 22px;"></i><span>Invoyislar</span><i class="bi bi-chevron-down ms-auto"></i>
                </a>
                <ul id="invoices-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
                    <li>
                        <a href="invoices-list.html">
                            <i style="font-size: 20px;" class="bi bi-list-check"></i><span>Ro'yxatni ko'rish</span>
                        </a>
                    </li>
                    <li>
                        <a href="invoices-add.html">
                            <i style="font-size: 20px;" class="bi bi-plus-circle"></i><span>Yangi yaratish</span>
                        </a>
                    </li>
                </ul>
            </li>
        </ul>
    </aside>

    <main id="main" class="main">
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="text-center">
                <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3">Yuklanmoqda...</p>
            </div>
        </div>

        <div class="p-4">
            <div class="row mb-4">
                <div class="col-12">
                    <h2 style="font-weight: 700; color: #e0a800; text-shadow: 0 0 2px #ffc107;">
                        <i class="bi bi-pencil-square me-2"></i>Guvohnomani Tahrirlash
                    </h2>
                    <p class="text-muted" id="documentInfo">
                        Guvohnoma ma'lumotlarini yangilang
                    </p>
                </div>
            </div>

            <!-- Форма редактирования -->
            <div class="row">
                <div class="col-12">
                    <div class="form-card">
                        <div class="form-header">
                            <h4 class="mb-0">
                                <i class="bi bi-file-text me-2"></i>
                                Guvohnoma Ma'lumotlarini Tahrirlash
                            </h4>
                            <small id="documentIdDisplay"></small>
                        </div>

                        <form id="editCertificateForm">
                            <!-- Скрытое поле для ID -->
                            <input type="hidden" id="documentId">
                            
                            <!-- 1. Talaba ma'lumotlari -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="bi bi-person-badge me-2"></i>Talaba Ma'lumotlari
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="editJshshir" class="form-label required">
                                            <i class="bi bi-card-text me-2"></i>JShShIR Raqami
                                        </label>
                                        <div class="input-group">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="editJshshir" 
                                                   maxlength="14"
                                                   pattern="[0-9]{14}"
                                                   placeholder="Masalan: 12345678901234"
                                                   required>
                                            <button class="btn btn-outline-warning" type="button" id="editSearchStudentBtn">
                                                <i class="bi bi-search"></i> Izlash
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            Talabaning 14 raqamli shaxsiy identifikatori
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="editStudentName" class="form-label required">
                                            <i class="bi bi-person-vcard me-2"></i>Talaba Ismi
                                        </label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="editStudentName" 
                                               placeholder="JShShIR ni kiriting"
                                               required>
                                        <div class="form-text">
                                            JShShIR ni kirgizgandan keyin avtomatik to'ldiriladi
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. O'quv kursi sanalari -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="bi bi-calendar-range me-2"></i>O'quv Kursi Sanalari
                                </h5>
                                
                                <div class="date-inputs">
                                    <div class="mb-3">
                                        <label for="editCourseStartDate" class="form-label required">
                                            <i class="bi bi-calendar-plus me-2"></i>Kurs Boshlanish Sanasi
                                        </label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="editCourseStartDate" 
                                               required>
                                        <div class="form-text">ДД.ММ.ГГГГ formatda</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="editCourseEndDate" class="form-label required">
                                            <i class="bi bi-calendar-check me-2"></i>Kurs Tugash Sanasi
                                        </label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="editCourseEndDate" 
                                               required>
                                        <div class="form-text">ДД.ММ.ГГГГ formatda</div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="editExamDate" class="form-label required">
                                            <i class="bi bi-calendar-event me-2"></i>Imtihon Sanasi
                                        </label>
                                        <input type="date" 
                                               class="form-control" 
                                               id="editExamDate" 
                                               required>
                                        <div class="form-text">ДД.ММ.ГГГГ formatda</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. O'quv kursi toifalari -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="bi bi-tags me-2"></i>O'quv Kursi Toifalari
                                </h5>
                                
                                <div class="checkbox-grid">
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryA" value="A">
                                        <label class="form-check-label" for="editCategoryA">A toifasi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryB" value="B">
                                        <label class="form-check-label" for="editCategoryB">B toifasi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryC" value="C">
                                        <label class="form-check-label" for="editCategoryC">C toifasi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryD" value="D">
                                        <label class="form-check-label" for="editCategoryD">D toifasi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryE" value="E">
                                        <label class="form-check-label" for="editCategoryE">E toifasi</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" class="form-check-input edit-category" id="editCategoryF" value="F">
                                        <label class="form-check-label" for="editCategoryF">F toifasi</label>
                                    </div>
                                </div>

                                <!-- Внутри раздела "O'quv kursi toifalari" добавьте: -->
<div class="row mt-3">
    <div class="col-md-4">
        <label for="editCourseHours" class="form-label required">
            <i class="bi bi-clock me-2"></i>O'quv Kursi Soatlari
        </label>
        <input type="number" 
               class="form-control" 
               id="editCourseHours" 
               min="1" 
               max="500"
               placeholder="Masalan: 120"
               required>
        <div class="form-text">Umumiy o'quv soatlari</div>
    </div>
    <div class="col-md-4">
        <label for="editCertificateNumber" class="form-label required">
            <i class="bi bi-file-earmark me-2"></i>Guvohnoma Raqami
        </label>
        <input type="text" 
               class="form-control" 
               id="editCertificateNumber" 
               placeholder="Guvohnoma raqami"
               required>
        <div class="form-text">Guvohnoma seriya raqami</div>
    </div>
    <!-- ДОБАВЬТЕ ЭТО ПОЛЕ: -->
    <div class="col-md-4">
        <label for="editCommissionNumber" class="form-label required">
            <i class="bi bi-file-text me-2"></i>Komissiya Bayoni Raqami
        </label>
        <input type="number" 
               class="form-control" 
               id="editCommissionNumber" 
               min="1"
               placeholder="Masalan: 15"
               required>
        <div class="form-text">Komissiya bayonining raqami</div>
    </div>
</div>
                            </div>

                            <!-- 4. Baholar va imzolar -->
                            <div class="form-section">
                                <h5 class="section-title">
                                    <i class="bi bi-award me-2"></i>Baholar va Imzolar
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label required">
                                            <i class="bi bi-check-circle me-2"></i>Y.H.Q Bahosi
                                        </label>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade1" id="editGrade3" value="3" required>
                                                <label class="form-check-label" for="editGrade3">3 baho</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade1" id="editGrade4" value="4">
                                                <label class="form-check-label" for="editGrade4">4 baho</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade1" id="editGrade5" value="5">
                                                <label class="form-check-label" for="editGrade5">5 baho</label>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <label for="editStatus" class="form-label">
                                                <i class="bi bi-circle-fill me-2"></i>Holati
                                            </label>
                                            <select class="form-select" id="editStatus">
                                                <option value="active">Faol</option>
                                                <option value="inactive">Faol emas</option>
                                                <option value="archived">Arxivlangan</option>
                                            </select>
                                        </div>
                                        <!-- Внутри раздела "Baholar va imzolar" добавьте поля для директора -->
<div class="row mt-3">
    <div class="col-md-6">
        <label for="editDirectorName" class="form-label">
            <i class="bi bi-person me-2"></i>Rahbar Ismi
        </label>
        <input type="text" 
               class="form-control" 
               id="editDirectorName" 
               placeholder="Ismi">
    </div>
    <div class="col-md-6">
        <label for="editDirectorSurname" class="form-label">
            <i class="bi bi-person me-2"></i>Rahbar Familiyasi
        </label>
        <input type="text" 
               class="form-control" 
               id="editDirectorSurname" 
               placeholder="Familiyasi">
    </div>
</div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label required">
                                            <i class="bi bi-check-circle me-2"></i>H.X.Q Bahosi
                                        </label>
                                        <div class="radio-group">
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade2" id="editGrade3b" value="3" required>
                                                <label class="form-check-label" for="editGrade3b">3 baho</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade2" id="editGrade4b" value="4">
                                                <label class="form-check-label" for="editGrade4b">4 baho</label>
                                            </div>
                                            <div class="radio-item">
                                                <input type="radio" class="form-check-input" name="editGrade2" id="editGrade5b" value="5">
                                                <label class="form-check-label" for="editGrade5b">5 baho</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. Qo'shimcha ma'lumotlar -->
                            <div class="form-section" style="border-bottom: none;">
                                <h5 class="section-title">
                                    <i class="bi bi-info-circle me-2"></i>Qo'shimcha Ma'lumotlar
                                </h5>
                                
                                <div class="mb-3">
                                    <label for="editAdditionalInfo" class="form-label">
                                        <i class="bi bi-chat-text me-2"></i>Qo'shimcha Izohlar
                                    </label>
                                    <textarea class="form-control" 
                                              id="editAdditionalInfo" 
                                              rows="3"
                                              placeholder="Qo'shimcha izohlar, tavsiyalar yoki eslatmalar..."></textarea>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="editAgreeTerms" required>
                                    <label class="form-check-label" for="editAgreeTerms">
                                        Barcha ma'lumotlar to'g'ri ekanligini tasdiqlayman
                                    </label>
                                </div>
                            </div>

                            <hr class="my-4">

                            <!-- Кнопки -->
                            <div class="d-flex justify-content-between">
                                <div>
                                    <a href="Guvohnomalar-list.html" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-2"></i>Orqaga
                                    </a>
                                    <button type="reset" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-eraser me-2"></i>Qayta boshlash
                                    </button>
                                    <button type="button" class="btn btn-outline-danger ms-2" onclick="deleteCurrentDocument()">
                                        <i class="bi bi-trash me-2"></i>O'chirish
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="bi bi-check-circle me-2"></i>Yangilashni Saqlash
                                    </button>
                                    <button type="button" class="btn btn-primary ms-2" onclick="saveAndPrint()">
                                        <i class="bi bi-printer me-2"></i>Saqlash va Chop etish
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Информационная панель -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <h5><i class="bi bi-exclamation-triangle me-2"></i>Ogohlantirish:</h5>
                                <ul class="mb-0">
                                    <li>Faqat zarur maydonlarni o'zgartiring</li>
                                    <li>Ma'lumotlarni tekshirib, keyin saqlang</li>
                                    <li>O'zgartirishlar darhol amalga oshiriladi</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Copyright <strong><span>2026 yil</span></strong>. Barcha huquqlar himoyalangan
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="documents.js"></script>
    <script>
    // Глобальные переменные
    let currentDocumentId = null;
    
    function logout() {
        if (confirm("Tizimdan chiqishni xohlaysizmi?")) {
            window.location.href = "index.html";
        }
    }

    // Показать/скрыть загрузку
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.display = show ? 'flex' : 'none';
        }
    }

    // Загрузка документа по ID из URL
   async function loadDocumentForEdit() {
    const urlParams = new URLSearchParams(window.location.search);
    currentDocumentId = urlParams.get('id');
    
    if (!currentDocumentId) {
        alert('Guvohnoma ID si ko\'rsatilmagan!');
        window.location.href = 'Guvohnomalar-list.html';
        return;
    }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    try {
        console.log('Loading document with ID:', currentDocumentId);
        const response = await fetch(`/api/documents/${currentDocumentId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const doc = await response.json();
        console.log('Document loaded:', doc);
        
        // Заполняем форму данными
        populateEditForm(doc);
        
    } catch (error) {
        console.error('Error loading document:', error);
        alert(`Guvohnoma yuklashda xatolik: ${error.message}`);
        window.location.href = 'Guvohnomalar-list.html';
    } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
    }
}

    // Заполнение формы данными (ИСПРАВЛЕННЫЙ!)
    // Заполнение формы данными (ИСПРАВЛЕННЫЙ!)
function populateEditForm(doc) {
    console.log('Populating form with:', doc);
    
    // Основные поля
    const docIdElement = document.getElementById('documentId');
    if (docIdElement) docIdElement.value = doc.id || '';
    
    const jshshirElement = document.getElementById('editJshshir');
    if (jshshirElement) jshshirElement.value = doc.student_jshshir || '';
    
    const studentNameElement = document.getElementById('editStudentName');
    if (studentNameElement) studentNameElement.value = doc.student_name || '';
    
    const startDateElement = document.getElementById('editCourseStartDate');
    if (startDateElement) startDateElement.value = doc.course_start || '';
    
    const endDateElement = document.getElementById('editCourseEndDate');
    if (endDateElement) endDateElement.value = doc.course_end || '';
    
    const examDateElement = document.getElementById('editExamDate');
    if (examDateElement) examDateElement.value = doc.exam_date || '';
    
    const hoursElement = document.getElementById('editCourseHours');
    if (hoursElement) hoursElement.value = doc.course_hours || 120;
    
    const certNumberElement = document.getElementById('editCertificateNumber');
    if (certNumberElement) certNumberElement.value = doc.certificate_number || '';
    
    // ДОБАВЬТЕ: Номер комиссии
    const commissionNumberElement = document.getElementById('editCommissionNumber');
    if (commissionNumberElement) commissionNumberElement.value = doc.commission_number || '15';
    
    const statusElement = document.getElementById('editStatus');
    if (statusElement) statusElement.value = doc.status || 'active';
    
    // ДОБАВЬТЕ: Имя директора (разделяем на имя и фамилию)
    const directorName = doc.director_name || 'N. ILYASOVA';
    const nameParts = directorName.split(' ');
    
    const directorNameElement = document.getElementById('editDirectorName');
    const directorSurnameElement = document.getElementById('editDirectorSurname');
    
    if (directorNameElement && nameParts.length > 0) {
        directorNameElement.value = nameParts[0] || 'N.';
    }
    if (directorSurnameElement && nameParts.length > 1) {
        directorSurnameElement.value = nameParts.slice(1).join(' ') || 'ILYASOVA';
    }
    
    // Категории
    const categories = doc.categories ? doc.categories.split(',').map(c => c.trim()) : [];
    console.log('Categories found:', categories);
    
    // Сбросить все чекбоксы
    const categoryCheckboxes = document.querySelectorAll('.edit-category');
    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Установить выбранные категории
    categories.forEach(category => {
        const checkboxId = `editCategory${category}`;
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = true;
        } else {
            console.log('Checkbox not found for category:', category, 'ID:', checkboxId);
        }
    });
    
    // Оценки
    if (doc.grade1) {
        const grade1Radio = document.querySelector(`input[name="editGrade1"][value="${doc.grade1}"]`);
        if (grade1Radio) {
            grade1Radio.checked = true;
        }
    }
    
    if (doc.grade2) {
        const grade2Radio = document.querySelector(`input[name="editGrade2"][value="${doc.grade2}"]`);
        if (grade2Radio) {
            grade2Radio.checked = true;
        }
    }
    
    // Автоматически соглашаемся с условиями
    const agreeTerms = document.getElementById('editAgreeTerms');
    if (agreeTerms) agreeTerms.checked = true;
}

    // Поиск студента по JShShIR
    const searchBtn = document.getElementById('editSearchStudentBtn');
    if (searchBtn) {
        searchBtn.addEventListener('click', async function() {
            const jshshirInput = document.getElementById('editJshshir');
            const studentNameInput = document.getElementById('editStudentName');
            
            if (!jshshirInput || !studentNameInput) return;
            
            const jshshir = jshshirInput.value.trim();
            
            if (jshshir.length !== 14) {
                showError('Iltimos, 14 raqamli JShShIR kiriting');
                return;
            }

            studentNameInput.value = 'Izlanmoqda...';
            studentNameInput.style.color = '#6c757d';

            try {
                const response = await fetch(`/api/students/${jshshir}`);
                
                if (!response.ok) {
                    throw new Error('Talaba topilmadi');
                }
                
                const student = await response.json();
                studentNameInput.value = student.full_name || 'Ismi mavjud emas';
                studentNameInput.style.color = '#212529';
                
            } catch (error) {
                console.error('Student search error:', error);
                studentNameInput.value = 'Talaba topilmadi';
                studentNameInput.style.color = '#dc3545';
            }
        });
    }

    // Сохранение изменений
    // Сохранение изменений
async function updateDocument(event) {
    event.preventDefault();
    
    if (!currentDocumentId) {
        showError('Guvohnoma ID si mavjud emas!');
        return;
    }
    
    // Проверяем согласие с условиями
    const agreeTerms = document.getElementById('editAgreeTerms');
    if (agreeTerms && !agreeTerms.checked) {
        showError('Iltimos, ma\'lumotlarning to\'g\'riligini tasdiqlang!');
        return;
    }
    
    // Получаем данные из формы
    const categories = [];
    const categoryCheckboxes = document.querySelectorAll('.edit-category:checked');
    categoryCheckboxes.forEach(checkbox => {
        categories.push(checkbox.value);
    });
    
    if (categories.length === 0) {
        showError('Kamida bitta toifani tanlang!');
        return;
    }
    
    const grade1 = document.querySelector('input[name="editGrade1"]:checked')?.value;
    const grade2 = document.querySelector('input[name="editGrade2"]:checked')?.value;
    
    if (!grade1 || !grade2) {
        showError('Barcha baholarni tanlang!');
        return;
    }
    
    const jshshirInput = document.getElementById('editJshshir');
    const studentNameInput = document.getElementById('editStudentName');
    const startDateInput = document.getElementById('editCourseStartDate');
    const endDateInput = document.getElementById('editCourseEndDate');
    const examDateInput = document.getElementById('editExamDate');
    const hoursInput = document.getElementById('editCourseHours');
    const certNumberInput = document.getElementById('editCertificateNumber');
    const commissionNumberInput = document.getElementById('editCommissionNumber');
    const statusInput = document.getElementById('editStatus');
    const directorNameInput = document.getElementById('editDirectorName');
    const directorSurnameInput = document.getElementById('editDirectorSurname');
    
    if (!jshshirInput || !studentNameInput || !startDateInput || !endDateInput || 
        !examDateInput || !hoursInput || !certNumberInput || !commissionNumberInput || !statusInput) {
        showError('Barcha maydonlar topilmadi!');
        return;
    }
    
    // Объединяем имя и фамилию директора
    let directorName = '';
    if (directorNameInput && directorSurnameInput) {
        directorName = `${directorNameInput.value.trim()} ${directorSurnameInput.value.trim()}`.trim();
    }
    
    const documentData = {
        title: "Traktor haydovchisi guvohnomasi",
        student_jshshir: jshshirInput.value,
        student_name: studentNameInput.value,
        course_start: startDateInput.value,
        course_end: endDateInput.value,
        exam_date: examDateInput.value,
        categories: categories.join(','),
        course_hours: parseInt(hoursInput.value) || 120,
        grade1: parseInt(grade1),
        grade2: parseInt(grade2),
        certificate_number: certNumberInput.value,
        status: statusInput.value,
        // ДОБАВЬТЕ ЭТИ ПОЛЯ:
        commission_number: commissionNumberInput.value,
        director_name: directorName || 'N. ILYASOVA'
    };
    
    console.log('Updating document with ID:', currentDocumentId, 'Data:', documentData);
    
    try {
        showLoading(true);
        
        const response = await fetch(`/api/documents/${currentDocumentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(documentData)
        });
        
        const responseText = await response.text();
        console.log('Update response:', response.status, responseText);
        
        if (!response.ok) {
            throw new Error(responseText || `HTTP ${response.status}`);
        }
        
        showSuccess('✅ Guvohnoma muvaffaqiyatli yangilandi!');
        
        setTimeout(() => {
            window.location.href = 'Guvohnomalar-list.html';
        }, 2000);
        
    } catch (error) {
        console.error('Update document error:', error);
        showError('❌ Guvohnoma yangilashda xatolik: ' + error.message);
    } finally {
        showLoading(false);
    }
}

    // Удаление текущего документа
    async function deleteCurrentDocument() {
        if (!currentDocumentId) {
            showError('Guvohnoma ID si mavjud emas!');
            return;
        }
        
        if (!confirm(`Rostdan ham guvohnoma #${currentDocumentId} ni o'chirmoqchimisiz?\nBu amalni bekor qilib bo'lmaydi!`)) {
            return;
        }
        
        try {
            showLoading(true);
            
            const response = await fetch(`/api/documents/${currentDocumentId}`, {
                method: "DELETE"
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || `HTTP ${response.status}`);
            }

            showSuccess('✅ Guvohnoma muvaffaqiyatli o\'chirildi!');
            
            setTimeout(() => {
                window.location.href = 'Guvohnomalar-list.html';
            }, 2000);

        } catch (error) {
            console.error("Delete certificate error:", error);
            showError(`❌ O'chirishda xatolik: ${error.message}`);
        } finally {
            showLoading(false);
        }
    }

    // Saqlash va chop etish
    function saveAndPrint() {
        if (confirm("Guvohnomani saqlab, chop etishni xohlaysizmi?")) {
            const form = document.getElementById('editCertificateForm');
            if (form) {
                const submitEvent = new Event('submit', { cancelable: true });
                form.dispatchEvent(submitEvent);
            }
        }
    }

    // Вспомогательные функции
    function showError(message) {
        // Вместо alert используем более мягкое уведомление
        const notification = document.createElement('div');
        notification.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
        notification.style.zIndex = '1060';
        notification.innerHTML = `
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    function showSuccess(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
        notification.style.zIndex = '1060';
        notification.innerHTML = `
            <i class="bi bi-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Edit page loaded');
        
        // Загружаем документ для редактирования
        loadDocumentForEdit();
        
        // Обработка формы
        const editForm = document.getElementById('editCertificateForm');
        if (editForm) {
            editForm.addEventListener('submit', updateDocument);
        }
        
        // Автоматический поиск при изменении JShShIR
        const jshshirInput = document.getElementById('editJshshir');
        if (jshshirInput) {
            jshshirInput.addEventListener('change', function() {
                if (this.value.length === 14) {
                    const searchBtn = document.getElementById('editSearchStudentBtn');
                    if (searchBtn) searchBtn.click();
                }
            });
        }
    });


        document.addEventListener('DOMContentLoaded', function() {
    const toggleSidebarBtn = document.querySelector('.toggle-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const body = document.body;
    
    if (toggleSidebarBtn && sidebar) {
        toggleSidebarBtn.addEventListener('click', function(e) {
            e.preventDefault();
            body.classList.toggle('toggle-sidebar');
            
            // Также можно добавить/удалить класс непосредственно к сайдбару
            sidebar.classList.toggle('collapsed');
            
            // Сохраняем состояние в localStorage
            if (body.classList.contains('toggle-sidebar')) {
                localStorage.setItem('sidebarCollapsed', 'true');
            } else {
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        });
        
        // Восстанавливаем состояние сайдбара при загрузке
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            body.classList.add('toggle-sidebar');
            sidebar.classList.add('collapsed');
        }
    }
    
    // Добавьте также этот код для автоматического сворачивания сайдбара на мобильных устройствах
    function handleResponsiveSidebar() {
        if (window.innerWidth <= 768) {
            body.classList.add('toggle-sidebar');
            sidebar.classList.add('collapsed');
        } else {
            // На десктопе восстанавливаем сохраненное состояние
            if (localStorage.getItem('sidebarCollapsed') !== 'true') {
                body.classList.remove('toggle-sidebar');
                sidebar.classList.remove('collapsed');
            }
        }
    }
    
    
});
</script>
</body>

</html>


